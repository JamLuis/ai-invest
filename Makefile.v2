# AI-Invest V2 Makefile
# æ”¯æŒnewspaperé›†æˆã€æ™ºèƒ½åˆ†æã€å½’æ¡£ç®¡ç†

.PHONY: v2-up v2-down v2-build v2-logs v2-status v2-test v2-clean v2-archive v2-crawl

# ======================
# V2ç‰ˆæœ¬ - åŸºç¡€æœåŠ¡ç®¡ç†
# ======================

v2-build:
	@echo "ğŸ”¨ æ„å»ºAI-Invest V2é•œåƒ..."
	docker-compose -f docker-compose.v2.yml build

v2-up:
	@echo "ğŸš€ å¯åŠ¨AI-Invest V2æœåŠ¡..."
	docker-compose -f docker-compose.v2.yml up -d
	@echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
	@sleep 10
	@make v2-status

v2-down:
	@echo "ğŸ›‘ åœæ­¢AI-Invest V2æœåŠ¡..."
	docker-compose -f docker-compose.v2.yml down

v2-restart: v2-down
	@sleep 3
	@make v2-up

# ======================
# V2ç‰ˆæœ¬ - æœåŠ¡çŠ¶æ€å’Œç›‘æ§
# ======================

v2-status:
	@echo "=== AI-Invest V2 æœåŠ¡çŠ¶æ€ ==="
	@docker-compose -f docker-compose.v2.yml ps
	@echo ""
	@echo "=== æœåŠ¡å¥åº·æ£€æŸ¥ ==="
	@if curl -s -f "http://localhost:8001/health" > /dev/null 2>&1; then \
		echo "âœ… APIæœåŠ¡æ­£å¸¸ (http://localhost:8001)"; \
	else \
		echo "âŒ APIæœåŠ¡ä¸å¯ç”¨"; \
	fi
	@echo ""
	@echo "=== æ•°æ®åº“ç»Ÿè®¡ ==="
	@docker exec ai-invest-postgres-v2 psql -U finance -d finance_v2 -c "SELECT 'articles_v2' as table_name, COUNT(*) as count FROM articles_v2 UNION SELECT 'news_sources', COUNT(*) FROM news_sources;" 2>/dev/null || echo "æ•°æ®åº“è¿æ¥å¤±è´¥"

v2-logs:
	@if [ -n "$(SERVICE)" ]; then \
		docker-compose -f docker-compose.v2.yml logs -f $(SERVICE); \
	else \
		echo "æŸ¥çœ‹æŒ‡å®šæœåŠ¡æ—¥å¿—: make v2-logs SERVICE=ai-invest-v2|news-scheduler|archive-cleaner"; \
		echo "æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—:"; \
		docker-compose -f docker-compose.v2.yml logs --tail=50; \
	fi

v2-shell:
	@if [ -n "$(SERVICE)" ]; then \
		docker exec -it ai-invest-$(SERVICE)-v2 /bin/bash; \
	else \
		echo "è¿›å…¥å®¹å™¨: make v2-shell SERVICE=app|postgres|scheduler"; \
		docker exec -it ai-invest-app-v2 /bin/bash; \
	fi

# ======================
# V2ç‰ˆæœ¬ - æ•°æ®åº“ç®¡ç†
# ======================

v2-db-init:
	@echo "ğŸ—„ï¸ åˆå§‹åŒ–V2æ•°æ®åº“..."
	docker exec -i ai-invest-postgres-v2 psql -U finance -d finance_v2 < src/db/schema_v2.sql
	@echo "æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ"

v2-db-reset:
	@echo "âš ï¸ è­¦å‘Šï¼šè¿™å°†æ¸…ç©ºV2æ•°æ®åº“æ‰€æœ‰æ•°æ®ï¼"
	@read -p "ç¡®è®¤è¦é‡ç½®æ•°æ®åº“å—ï¼Ÿ(y/N): " confirm && [ "$$confirm" = "y" ] || { echo "æ“ä½œå·²å–æ¶ˆ"; exit 1; }
	@echo "é‡ç½®V2æ•°æ®åº“..."
	@docker exec ai-invest-postgres-v2 psql -U finance -d finance_v2 -c "DROP SCHEMA IF EXISTS public CASCADE; CREATE SCHEMA public;"
	@make v2-db-init
	@echo "æ•°æ®åº“å·²é‡ç½®"

v2-db-backup:
	@echo "ğŸ“¦ å¤‡ä»½V2æ•°æ®åº“..."
	@mkdir -p backups
	docker exec ai-invest-postgres-v2 pg_dump -U finance finance_v2 > backups/finance_v2_$(shell date +%Y%m%d_%H%M%S).sql
	@echo "å¤‡ä»½å®Œæˆ: backups/finance_v2_$(shell date +%Y%m%d_%H%M%S).sql"

v2-db-restore:
	@if [ -z "$(BACKUP_FILE)" ]; then \
		echo "ä½¿ç”¨æ–¹å¼: make v2-db-restore BACKUP_FILE=backups/finance_v2_20231031_120000.sql"; \
		exit 1; \
	fi
	@echo "ğŸ“¥ æ¢å¤V2æ•°æ®åº“..."
	@make v2-db-reset
	docker exec -i ai-invest-postgres-v2 psql -U finance -d finance_v2 < $(BACKUP_FILE)
	@echo "æ•°æ®åº“æ¢å¤å®Œæˆ"

# ======================
# V2ç‰ˆæœ¬ - å†…å®¹æŠ“å–å’Œç®¡ç†
# ======================

v2-crawl:
	@if [ -z "$(URL)" ]; then \
		echo "ä½¿ç”¨æ–¹å¼: make v2-crawl URL=https://example.com/news/article"; \
		exit 1; \
	fi
	@echo "ğŸ•·ï¸ æŠ“å–æ–‡ç« : $(URL)"
	@curl -X POST "http://localhost:8001/crawl?url=$(URL)" -H "Content-Type: application/json" | python3 -m json.tool

v2-crawl-batch:
	@echo "ğŸ•·ï¸ æ‰¹é‡æŠ“å–é«˜ä¼˜å…ˆçº§æ–°é—»æº..."
	docker exec ai-invest-app-v2 python -m src.newspaper_crawler
	@echo "æ‰¹é‡æŠ“å–å®Œæˆ"

v2-schedule-start:
	@echo "â° å¯åŠ¨æ–°é—»è°ƒåº¦å™¨..."
	docker exec -d ai-invest-scheduler-v2 python -m src.news_scheduler
	@echo "è°ƒåº¦å™¨å·²å¯åŠ¨"

# ======================
# V2ç‰ˆæœ¬ - å½’æ¡£å’Œæ¸…ç†
# ======================

v2-archive:
	@echo "ğŸ“ æ‰§è¡Œæ–‡ç« å½’æ¡£..."
	docker exec ai-invest-app-v2 python -m src.archive_manager --action archive
	@echo "å½’æ¡£å®Œæˆ"

v2-cleanup:
	@echo "ğŸ§¹ æ‰§è¡Œå®Œæ•´æ¸…ç†..."
	docker exec ai-invest-app-v2 python -m src.archive_manager --action full
	@echo "æ¸…ç†å®Œæˆ"

v2-archive-stats:
	@echo "ğŸ“Š å½’æ¡£ç»Ÿè®¡ä¿¡æ¯:"
	@curl -s "http://localhost:8001/archive/stats" | python3 -m json.tool

# ======================
# V2ç‰ˆæœ¬ - APIæµ‹è¯•
# ======================

v2-test:
	@echo "ğŸ§ª æµ‹è¯•AI-Invest V2 API..."
	@echo "1. å¥åº·æ£€æŸ¥:"
	@curl -s "http://localhost:8001/health" | python3 -m json.tool
	@echo ""
	@echo "2. è·å–æ–‡ç« ç»Ÿè®¡:"
	@curl -s "http://localhost:8001/stats" | python3 -m json.tool
	@echo ""
	@echo "3. è·å–åˆ†ç±»åˆ—è¡¨:"
	@curl -s "http://localhost:8001/categories" | python3 -m json.tool
	@echo ""
	@echo "4. è·å–æœ€æ–°æ–‡ç«  (å‰3ç¯‡):"
	@curl -s "http://localhost:8001/articles?limit=3" | python3 -m json.tool

v2-test-search:
	@if [ -z "$(Q)" ]; then \
		echo "ä½¿ç”¨æ–¹å¼: make v2-test-search Q=SEC"; \
		exit 1; \
	fi
	@echo "ğŸ” æœç´¢æµ‹è¯•: $(Q)"
	@curl -s "http://localhost:8001/search?q=$(Q)&limit=5" | python3 -m json.tool

v2-test-categories:
	@echo "ğŸ“‚ æŒ‰åˆ†ç±»æŸ¥è¯¢æµ‹è¯•:"
	@curl -s "http://localhost:8001/articles?category=regulation&limit=3" | python3 -m json.tool

v2-test-importance:
	@echo "â­ æŒ‰é‡è¦æ€§æŸ¥è¯¢æµ‹è¯• (>80åˆ†):"
	@curl -s "http://localhost:8001/articles?min_importance=80&limit=3" | python3 -m json.tool

# ======================
# V2ç‰ˆæœ¬ - å¼€å‘å·¥å…·
# ======================

v2-dev-setup:
	@echo "ğŸ› ï¸ è®¾ç½®V2å¼€å‘ç¯å¢ƒ..."
	pip install -r requirements.txt
	@echo "å¼€å‘ç¯å¢ƒè®¾ç½®å®Œæˆ"

v2-dev-run-api:
	@echo "ğŸš€ å¯åŠ¨V2å¼€å‘APIæœåŠ¡..."
	@export POSTGRES_HOST=localhost && \
	export POSTGRES_PORT=5433 && \
	export POSTGRES_DB=finance_v2 && \
	python -m src.api_v2

v2-dev-run-scheduler:
	@echo "â° å¯åŠ¨V2å¼€å‘è°ƒåº¦å™¨..."
	@export POSTGRES_HOST=localhost && \
	export POSTGRES_PORT=5433 && \
	export POSTGRES_DB=finance_v2 && \
	python -m src.news_scheduler

v2-dev-crawl:
	@if [ -z "$(URL)" ]; then \
		echo "ä½¿ç”¨æ–¹å¼: make v2-dev-crawl URL=https://example.com"; \
		exit 1; \
	fi
	@export POSTGRES_HOST=localhost && \
	export POSTGRES_PORT=5433 && \
	export POSTGRES_DB=finance_v2 && \
	python -m src.newspaper_crawler $(URL)

# ======================
# V2ç‰ˆæœ¬ - æ¸…ç†å’Œç»´æŠ¤
# ======================

v2-clean:
	@echo "ğŸ§¹ æ¸…ç†V2ç›¸å…³èµ„æº..."
	docker-compose -f docker-compose.v2.yml down -v
	docker system prune -f
	@echo "æ¸…ç†å®Œæˆ"

v2-clean-all:
	@echo "âš ï¸ è­¦å‘Šï¼šè¿™å°†åˆ é™¤æ‰€æœ‰V2æ•°æ®å’Œé•œåƒï¼"
	@read -p "ç¡®è®¤è¦æ¸…ç†æ‰€æœ‰V2èµ„æºå—ï¼Ÿ(y/N): " confirm && [ "$$confirm" = "y" ] || { echo "æ“ä½œå·²å–æ¶ˆ"; exit 1; }
	docker-compose -f docker-compose.v2.yml down -v --rmi all
	docker volume rm ai-invest_postgres_v2_data ai-invest_kafka_v2_data 2>/dev/null || true
	rm -rf data/archives/* logs/*
	@echo "æ‰€æœ‰V2èµ„æºå·²æ¸…ç†"

# ======================
# V2ç‰ˆæœ¬ - å¸®åŠ©ä¿¡æ¯
# ======================

v2-help:
	@echo "AI-Invest V2 ç®¡ç†å‘½ä»¤ï¼š"
	@echo ""
	@echo "åŸºç¡€æœåŠ¡:"
	@echo "  v2-build        æ„å»ºV2é•œåƒ"
	@echo "  v2-up           å¯åŠ¨V2æœåŠ¡"
	@echo "  v2-down         åœæ­¢V2æœåŠ¡"
	@echo "  v2-restart      é‡å¯V2æœåŠ¡"
	@echo "  v2-status       æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
	@echo "  v2-logs         æŸ¥çœ‹æ—¥å¿— (SERVICE=æœåŠ¡å)"
	@echo ""
	@echo "æ•°æ®åº“ç®¡ç†:"
	@echo "  v2-db-init      åˆå§‹åŒ–æ•°æ®åº“"
	@echo "  v2-db-reset     é‡ç½®æ•°æ®åº“"
	@echo "  v2-db-backup    å¤‡ä»½æ•°æ®åº“"
	@echo "  v2-db-restore   æ¢å¤æ•°æ®åº“ (BACKUP_FILE=æ–‡ä»¶è·¯å¾„)"
	@echo ""
	@echo "å†…å®¹æŠ“å–:"
	@echo "  v2-crawl        æŠ“å–å•ç¯‡æ–‡ç«  (URL=ç½‘å€)"
	@echo "  v2-crawl-batch  æ‰¹é‡æŠ“å–"
	@echo ""
	@echo "å½’æ¡£æ¸…ç†:"
	@echo "  v2-archive      æ‰§è¡Œå½’æ¡£"
	@echo "  v2-cleanup      å®Œæ•´æ¸…ç†"
	@echo "  v2-archive-stats å½’æ¡£ç»Ÿè®¡"
	@echo ""
	@echo "APIæµ‹è¯•:"
	@echo "  v2-test         åŸºç¡€APIæµ‹è¯•"
	@echo "  v2-test-search  æœç´¢æµ‹è¯• (Q=å…³é”®è¯)"
	@echo ""
	@echo "å¼€å‘å·¥å…·:"
	@echo "  v2-dev-setup    è®¾ç½®å¼€å‘ç¯å¢ƒ"
	@echo "  v2-dev-run-api  å¯åŠ¨å¼€å‘API"
	@echo ""
	@echo "æ¸…ç†ç»´æŠ¤:"
	@echo "  v2-clean        æ¸…ç†èµ„æº"
	@echo "  v2-clean-all    æ¸…ç†æ‰€æœ‰èµ„æº"

# é»˜è®¤æ˜¾ç¤ºå¸®åŠ©
v2:
	@make v2-help