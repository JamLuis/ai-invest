# AI-Invest V2 - Newspaper重构项目总结 📰

## 🎯 项目目标实现

基于原有需求，成功重构AI-Invest项目，使用newspaper3k库替代RSS订阅方式，实现：

### ✅ 核心功能实现

1. **智能网页内容抓取**
   - 使用newspaper3k进行网页内容提取
   - 支持标题、正文、摘要、作者、发布时间提取
   - 自动图片和关键词提取

2. **智能分类和标签系统**
   - 自动分类：earnings, mergers, regulation, monetary, crypto, technology
   - 动态标签提取和管理
   - VIP实体识别（重要公司、人物、机构）

3. **重要性评分算法**
   - 时效性权重 (25%)
   - 来源可信度权重 (20%)
   - 实体重要性权重 (20%)
   - 市场关键词权重 (15%)
   - 情感影响权重 (10%)
   - 社交信号权重 (10%)

4. **数据持久化存储**
   - PostgreSQL数据库增强版表结构
   - Docker卷持久化，重启不丢数据
   - 支持articles_v2, news_sources, tags等多表设计

5. **90天自动归档机制**
   - 超过90天的新闻自动归档为文件
   - 支持jsonl.gz, json, csv格式
   - 365天后自动删除归档文件
   - 提供完整的清理脚本

6. **Docker容器化部署**
   - 多服务架构：API、调度器、归档清理器
   - 数据和日志完全持久化
   - 容器重启不影响数据和配置

## 🏗️ 系统架构

### 微服务架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   API服务       │    │   调度器服务     │    │   归档清理服务   │
│   (api_v2.py)   │    │ (news_scheduler) │    │(archive_manager)│
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
         ┌─────────────────┐    ┌─────────────────┐
         │   PostgreSQL    │    │     文件存储     │
         │   (finance_v2)  │    │   (archives/)   │
         └─────────────────┘    └─────────────────┘
```

### 数据流
```
网页URL → newspaper3k → 内容提取 → 分类标签 → 重要性评分 → 数据库存储
                                                              ↓
                                         90天后 → 文件归档 → 365天后删除
```

## 📊 新功能特性

### 1. 智能内容抓取 (src/newspaper_crawler.py)
- **newspaper3k集成**：自动提取网页结构化内容
- **错误处理**：网络超时、解析失败的完善处理
- **元数据提取**：作者、发布时间、图片、关键词

### 2. 增强API接口 (src/api_v2.py)
- **分类搜索**：`/articles?category=regulation`
- **重要性过滤**：`/articles?min_importance=80`
- **标签查询**：`/articles?tags=SEC,earnings`
- **全文搜索**：`/search?q=keywords`
- **统计信息**：`/stats`, `/categories`, `/tags`

### 3. 智能调度系统 (src/news_scheduler.py)
- **多优先级抓取**：
  - 高优先级（监管、央行）：30分钟
  - 中优先级（财经媒体）：1小时
  - 低优先级（综合新闻）：2小时
- **去重机制**：自动跳过已抓取文章
- **错误恢复**：单个源失败不影响其他源

### 4. 归档清理系统 (src/archive_manager.py)
- **自动归档**：90天后转存文件
- **多格式支持**：jsonl.gz(推荐), json, csv
- **批量处理**：每次1000篇，避免内存溢出
- **统计报告**：归档数量、文件大小、释放空间

## 🚀 部署和使用

### 快速启动
```bash
# 构建和启动V2服务
make v2-build
make v2-up

# 查看服务状态
make v2-status

# 测试API功能
make v2-test
```

### 配置管理
- **主配置**：`.env.v2` - 所有服务配置
- **新闻源**：数据库 `news_sources` 表
- **关键词规则**：`config_v2.py` 中的分类和评分规则

### 数据管理
```bash
# 手动抓取文章
make v2-crawl URL=https://example.com/news/article

# 执行归档
make v2-archive

# 数据库备份
make v2-db-backup

# 查看归档统计
make v2-archive-stats
```

## 📈 性能优化

### 1. 抓取性能
- **并发控制**：最大10个并发请求
- **速率限制**：请求间隔1秒
- **超时设置**：30秒请求超时
- **去重优化**：数据库级别URL去重

### 2. 存储优化
- **索引优化**：发布时间、重要性评分、分类等字段
- **全文搜索**：PostgreSQL GIN索引支持
- **分区存储**：按分类归档文件

### 3. 内存管理
- **批量处理**：归档时分批1000篇处理
- **流式读取**：大文件不加载到内存
- **定期清理**：Docker容器日志轮转

## 🔧 开发工具

### API测试
```bash
# 基础功能测试
make v2-test

# 搜索功能测试
make v2-test-search Q="Federal Reserve"

# 分类查询测试
make v2-test-categories

# 重要性过滤测试  
make v2-test-importance
```

### 开发环境
```bash
# 设置开发环境
make v2-dev-setup

# 本地运行API服务
make v2-dev-run-api

# 本地运行调度器
make v2-dev-run-scheduler
```

## 📋 数据库结构

### 核心表设计
- **articles_v2**：增强版文章表，支持分类、标签、评分
- **news_sources**：新闻源配置表，管理可信度和更新频率
- **tags**：标签管理表，统计使用频次
- **entities**：实体表，存储公司、人物等重要实体
- **archive_records**：归档记录表，跟踪文件归档历史

### 关键字段
- **importance_score**：0-100重要性评分
- **urgency_level**：critical/high/normal紧急程度
- **category/subcategory**：主分类和子分类
- **tags[]**：标签数组，支持GIN索引
- **is_archived**：归档标记

## 🎯 后续扩展

### 1. AI增强功能
- **情感分析**：TextBlob或外部API集成
- **实体识别**：spaCy NER模型集成
- **摘要生成**：transformer模型自动摘要

### 2. 监控告警
- **重要新闻告警**：高分文章推送
- **异常监控**：抓取失败、服务异常告警
- **性能监控**：Prometheus + Grafana集成

### 3. 数据分析
- **趋势分析**：热门话题和关键词趋势
- **情感指数**：市场情感指标
- **影响力评估**：新闻对股价的影响分析

## 🚨 注意事项

### 1. 资源管理
- **存储空间**：归档文件需要充足磁盘空间
- **网络带宽**：大量抓取需要稳定网络
- **请求频率**：遵守网站robots.txt和速率限制

### 2. 法律合规
- **版权声明**：遵守内容版权法规
- **数据使用**：符合网站使用条款
- **隐私保护**：不存储个人敏感信息

### 3. 维护建议
- **定期备份**：重要数据定期备份
- **日志监控**：关注错误日志和性能指标
- **配置更新**：根据需求调整抓取频率和规则

---

## 🎉 总结

AI-Invest V2成功实现了从RSS订阅到智能网页抓取的升级，具备：

✅ **实时性提升**：直接抓取网页，无需等待RSS更新  
✅ **内容质量**：完整文章内容而非摘要  
✅ **智能分析**：自动分类、标签、重要性评分  
✅ **数据管理**：持久化存储、自动归档、清理机制  
✅ **容器化部署**：Docker完整部署方案  
✅ **扩展性强**：微服务架构，易于扩展新功能  

项目已在`feature/newspaper-refactor`分支中完整实现，可以开始测试和部署使用。

*项目重构完成时间：2025-10-31*  
*分支：feature/newspaper-refactor*  
*版本：v2.0.0*